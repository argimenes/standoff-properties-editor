<!DOCTYPE html>
<html>
<head>
    <title>Editor</title>
    <meta http-equiv="content-type" content="text/html;charset=UTF-8" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta content="" name="description" />
    <meta content="" name="author" />
    <!-- BEGIN PLUGIN CSS -->
    <link href="css/plugins/bootstrapv3/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="css/plugins/bootstrapv3/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css" />
    <link href="css/plugins/font-awesome/css/font-awesome.css" rel="stylesheet" type="text/css" />
    <!-- END PLUGIN CSS -->
    <!-- BEGIN CORE CSS FRAMEWORK -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- END CORE CSS FRAMEWORK -->    
    <link href="css/app/editor.css" rel="stylesheet" type="text/css" />
</head>
<body style="background-color: #efefef;">    
<section id="main-template">
    <div class="container" style="margin-top: 40px;">
        <div class="row">
            <div class="col-md-6">
                <label>
                    File
                </label>
                <div class="input-group">
                    <select class="form-control" data-bind="value: $data.file, options: $data.files"></select>
                    <span class="input-group-btn">
                        <button class="btn btn-primary" data-bind="click: $data.loadClicked">Load</button>
                    </span>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-2">
                <label>
                    Line height
                </label>
                <div class="input-group">
                        <input type="text" class="form-control" data-bind="value: $data.lineHeight">
                        <span class="input-group-btn">
                            <button class="btn btn-primary" data-bind="click: $data.changeLineHeightClicked">Change</button>
                        </span>
                </div>
            </div>
            <div class="col-md-2">
                    <label>
                        Font size
                    </label>
                    <div class="input-group">
                            <input type="text" class="form-control" data-bind="value: $data.fontSize">
                            <span class="input-group-btn">
                                <button class="btn btn-primary" data-bind="click: $data.changeFontSizeClicked">Change</button>
                            </span>
                    </div>
                </div>
                <div class="col-md-3">
                    <label>
                        Font family
                    </label>
                    <div class="input-group">
                            <input type="text" class="form-control" data-bind="value: $data.fontFamily">
                            <span class="input-group-btn">
                                <button class="btn btn-primary" data-bind="click: $data.changeFontFamilyClicked">Change</button>
                            </span>
                    </div>
                </div>
                <div class="col-md-2">
                    <label>
                        Text colour
                    </label>
                    <div class="input-group">
                            <input type="text" class="form-control" data-bind="value: $data.textColour">
                            <span class="input-group-btn">
                                <button class="btn btn-primary" data-bind="click: $data.changeTextColourClicked">Change</button>
                            </span>
                    </div>
                </div>
                <div class="col-md-2">
                    <label>
                        Background colour
                    </label>
                    <div class="input-group">
                            <input type="text" class="form-control" data-bind="value: $data.backgroundColour">
                            <span class="input-group-btn">
                                <button class="btn btn-primary" data-bind="click: $data.changeBackgroundColourClicked">Change</button>
                            </span>
                    </div>
                </div>
        </div>
        <div class="row">
            <div class="col-md-12">                
                <div style="margin-top: 20px;">                    
                    <div style="display: inline-block; margin-right: 20px;">
                        <div>
                            <label>
                                Styles
                            </label>
                        </div>
                        <button class="btn btn-default tip" data-toggle="tooltip" data-original-title="Bold" data-bind="click: $data.boldClicked, css: { 'active': $data.isActiveMode('bold') }"><span class="fa fa-bold"></span></button>
                        <button class="btn btn-default tip" data-toggle="tooltip" data-original-title="Italics" data-bind="click: $data.italicsClicked, css: { 'active': $data.isActiveMode('italics') }"><span class="fa fa-italic"></span></button>
                        <button class="btn btn-default tip" data-toggle="tooltip" data-original-title="Strike-through" data-bind="click: $data.strikeClicked, css: { 'active': $data.isActiveMode('strike') }"><span class="fa fa-strikethrough"></span></button>
                        <button class="btn btn-default tip" data-toggle="tooltip" data-original-title="Underline" data-bind="click: $data.underlineClicked, css: { 'active': $data.isActiveMode('underline') }"><span class="fa fa-underline"></span></button>
                        <button class="btn btn-default tip" data-toggle="tooltip" data-original-title="Superscript" data-bind="click: $data.superscriptClicked, css: { 'active': $data.isActiveMode('superscript') }"><span class="fa fa-superscript"></span></button>
                        <button class="btn btn-default tip" data-toggle="tooltip" data-original-title="Subscript" data-bind="click: $data.subscriptClicked, css: { 'active': $data.isActiveMode('subscript') }"><span class="fa fa-subscript"></span></button>
                        <button class="btn btn-default tip" data-toggle="tooltip" data-original-title="Space" data-bind="click: $data.spaceClicked, css: { 'active': $data.isActiveMode('space') }"><span class="fa fa-space-shuttle"></span></button>
                    </div>
                    <div style="display: inline-block; margin-right: 20px;">
                        <div>
                            <label>
                                Layout
                            </label>
                        </div>
                        <button class="btn btn-default tip" data-toggle="tooltip" data-original-title="Hyphen" data-bind="click: $data.hyphenClicked"><span style="font-weight: 600;">-</span></button>
                        <button class="btn btn-default tip" data-toggle="tooltip" data-original-title="Line" data-bind="click: $data.lineClicked"><span class="fa fa-arrows-h"></span></button>
                        <button class="btn btn-default tip" data-toggle="tooltip" data-original-title="Paragraph" data-bind="click: $data.paragraphClicked"><span class="fa fa-paragraph"></span></button>
                        <button class="btn btn-default tip" data-toggle="tooltip" data-original-title="Page" data-bind="click: $data.pageClicked"><span style="font-weight: 600;">P</span></button>
                    </div>
                    <div style="display: inline-block; margin-right: 20px;">
                        <div>
                            <label>
                                Annotations
                            </label>
                        </div>
                        <button style="border-bottom: 3px solid red;" data-toggle="tooltip" data-original-title="Person" class="btn btn-default tip" data-bind="click: $data.personClicked"><span class="fa fa-user"></span></button>
			    <button style="border-bottom: 3px solid pink;" data-toggle="tooltip" data-original-title="Place" class="btn btn-default tip" data-bind="click: $data.placeClicked"><span class="fa fa-map"></span></button>
			    <button style="border-bottom: 3px solid cyan;" data-toggle="tooltip" data-original-title="Date" class="btn btn-default tip" data-bind="click: $data.dateClicked"><span class="fa fa-clock-o"></span></button>
                        <button style="border-bottom: 3px solid blue;" data-toggle="tooltip" data-original-title="Event" class="btn btn-default tip" data-bind="click: $data.eventClicked"><span class="fa fa-calendar"></span></button>
                        <button style="border-bottom: 3px solid green;" data-toggle="tooltip" data-original-title="Concept" class="btn btn-default tip" data-bind="click: $data.conceptClicked"><span class="fa fa-lightbulb-o"></span></button>
			<button style="border-bottom: 3px solid yellow;" data-toggle="tooltip" data-original-title="Text" class="btn btn-default tip" data-bind="click: $data.textClicked"><span class="fa fa-file-text"></span></button>
			<button style="border-bottom: 3px solid lightgreen;" data-toggle="tooltip" data-original-title="Web Link" class="btn btn-default tip" data-bind="click: $data.webLinkClicked"><span class="fa fa-link"></span></button>
            
                    </div>                    
                </div> 
                <div class="row" style="margin-top: 10px;">
                    <div class="col-md-12">
                        <div data-role="editor" spellcheck="false" contenteditable="true" class="editor"></div>
                        <div data-role="monitor" class="form-control monitor"></div>
                    </div>
                </div>
                <div class="row" style="margin-top: 10px;">
                    <div class="col-md-12">
                        <button class="btn btn-default" data-bind="click: $data.cancelClicked">Cancel</button> <button class="btn btn-primary" data-bind="click: $data.saveClicked">Save</button>
                    </div>
                </div>
                <hr />
                <div class="row">
                    <div class="col-md-12">
                        <button class="btn btn-primary" data-bind="click: $data.unbindClicked">Unbind</button> <button class="btn btn-primary" data-bind="click: $data.bindClicked">Bind</button>
                    </div>
                </div>
                <div class="row" style="margin-top: 10px;">
                    <div class="col-md-12">
                        <textarea class="form-control" rows="5" data-bind="value: $data.viewer"></textarea>
                    </div>
                </div>

            </div>
        </div>
    </div>
</section>
    <script src="scripts/require.js"></script>
    <script src="scripts/app/app.require.config.js"></script>    
	<script>
        var editor;
        require(["app/modules/standoff-properties-editor", "knockout", "jquery", "bootstrap"], function (Editor, ko, $) {

            //
            // This ensures that tooltips are applied to all targets, whether or not they are dynamically created.
            //
            $("body").tooltip({
                selector: '[data-toggle="tooltip"]'
            });

            // useful for HtmlCollection, NodeList, String types (array-like types)
            function forEach(array, callback, scope){
                for (var i=0,n=array.length; i<n; i++) {
                    callback.call(scope, array[i], i, array);
                }
            } // passes back stuff we need

            function changeCss(selectorText, tgtAttribName, newValue)
            {
                var styleSheets = document.styleSheets;
                forEach(styleSheets, styleSheetFunc);

                function styleSheetFunc(sheet)
                {
                    try{
                        forEach(sheet.cssRules, cssRuleFunc);
                    } catch(ex) {
                         
                    }
                }

                function cssRuleFunc(rule)
                {
                    if (selectorText.indexOf(rule.selectorText) != -1){
                        forEach(rule.style, cssRuleAttributeFunc);
                    }

                    function cssRuleAttributeFunc(attribName)
                    {
                        if (attribName == tgtAttribName)
                        {
                            rule.style[attribName] = newValue;
                            console.log('attribute replaced');
                        }
                    }
                }
            }

			var Model = (function(){
				function Model(cons){
                    var _ = this;
                    this.file = ko.observable("ReggF3-H19-316.json");
                    this.files = ko.observableArray([
                        "ReggF3-H19-316.json",
                        "ReggF3-H19-316-no-annotations.json",
                        "adam-liszt.json"
                        ]);            
                    this.lineHeight = ko.observable("2em");           
                    this.fontSize = ko.observable("1.5em"); 
                    this.fontFamily = ko.observable("monospace"); 
                    this.textColour = ko.observable("#000"); 
                    this.backgroundColour = ko.observable("#FFF"); 
                    this.currentModes = ko.observableArray([]);
                    this.userGuid = "abcd-efgh-ijkl-mnop";
                    this.viewer = ko.observable();
					this.editor = new Editor({
						container: cons.template.querySelectorAll("[data-role='editor']")[0],
						monitor: cons.template.querySelectorAll("[data-role='monitor']")[0],
                        onPropertyCreated: function (prop, data) {
                            // Copy the custom fields across from the JSON data to the Property.
                            if (!data) {
                                prop.userGuid = _.userGuid;
                                return;
                            }
                            prop.userGuid = data.userGuid;
                            prop.deletedByUserGuid = data.deletedByUserGuid;
                            prop.modifiedByUserGuid = data.modifiedByUserGuid;
                        },
                        onPropertyChanged: function (prop) {
                            if (!_.userGuid) {
                                return;
                            }
                            prop.modifiedByUserGuid = _.userGuid;
                        },
                        onPropertyDeleted: function (prop) {
                            if (!_.userGuid) {
                                return;
                            }
                            prop.deletedByUserGuid = _.userGuid;
                        },
                        onPropertyUnbound: function (data, prop) {
                            // Copy the custom fields across from the Property to the JSON data.
                            data.userGuid = prop.userGuid;
                            data.deletedByUserGuid = prop.deletedByUserGuid;
                            data.modifiedByUserGuid = prop.modifiedByUserGuid;
                        },
                        onMonitorUpdated: function(types) {
                            _.currentModes([]);
                            var modes = types.filter(function(x){ return x.format == "style"; }).map(function(x) { return x.type; });
                            _.currentModes(modes);
                        },
						commentManager: function (prop) {
							// Handle the adding of a user comment to any standoff property.
                            var value = prompt("Comment", prop.value || "");
                            process(value);
						},
						monitorButton: {
                            link: '<button data-toggle="tooltip" data-original-title="Edit" class="btn btn-sm"><span class="fa fa-link"></span></button>',
                            layer: '<button data-toggle="tooltip" data-original-title="Layer" class="btn btn-sm"><span class="fa fa-cog"></span></button>',
                            remove: '<button data-toggle="tooltip" data-original-title="Delete" class="btn btn-sm"><span class="fa fa-trash"></span></button>',
                            comment: '<button data-toggle="tooltip" data-original-title="Comment" class="btn btn-sm"><span class="fa fa-comment"></span></button>',
                            shiftLeft: '<button data-toggle="tooltip" data-original-title="Left" class="btn btn-sm"><span class="fa fa-arrow-circle-left"></span></button>',
                            shiftRight: '<button data-toggle="tooltip" data-original-title="Right" class="btn btn-sm"><span class="fa fa-arrow-circle-right"></span></button>',
                            expand: '<button data-toggle="tooltip" data-original-title="Expand" class="btn btn-sm"><span class="fa fa-plus-circle"></span></button>',
                            contract: '<button data-toggle="tooltip" data-original-title="Contract" class="btn btn-sm"><span class="fa fa-minus-circle"></span></button>',
                            toZeroPoint: '<button data-toggle="tooltip" data-original-title="Convert to zero point" class="btn btn-sm"><span style="font-weight: 600;">Z</span></button>',
                            zeroPointLabel: '<button data-toggle="tooltip" data-original-title="Label" class="btn btn-sm"><span class="fa fa-file-text-o"></span></button>',
                        },
                        unbinding: {
                            //maxTextLength: 20
                        },
						 propertyType: {
                    bold: {
                        format: "style",
                        shortcut: "b",
                        className: "bold",
                        labelRenderer: function () {
                            return "<b>bold</b>";
                        }
                    },
                    italics: {
                        format: "style",
                        shortcut: "i",
                        className: "italic",
                        labelRenderer: function () {
                            return "<em>italics</em>";
                        }
                    },
                    hyphen: {
                        format: "zero-point",
                        className: "hyphen",
                        content: "-"
                    },
                    strike: {
                        format: "style",
                        className: "line-through"
                    },
                    underline: {
                        format: "style",
                        shortcut: "u",
                        className: "underline"
                    },
                    superscript: {
                        format: "style",
                        className: "superscript"
                    },
                    subscript: {
                        format: "style",
                        className: "subscript"
                    },
                    space: {
                        format: "style",
                        className: "space"
                    },
                    line: {
                        format: "style",
                        className: "line"
                    },
                    page: {
                        format: "style",
                        className: "page",
                        labelRenderer: function (prop) {
                            return "page " + prop.value;
                        },
                        propertyValueSelector: function (prop, process) {
                            var num = prompt("Page number?", prop.value || "");
                            process(num);
                        }
                    },
                    paragraph: {
                        format: "style",
                        className: "paragraph"
                    },
                    person: {
                        format: "entity",
                        shortcut: "p",
                        className: "person",
                        labelRenderer: function (prop) {
                            return prop.name ? "person (" + prop.name +")" : "person";
                        },
                        propertyValueSelector: function (prop, process) {
                           var uuid = prompt("Person UUID?", prop.value || "");
                            process(uuid);
                        },
                    },
                    "event": {
                        format: "entity",
                        className: "event",
                        propertyValueSelector: function (prop, process) {
                            var uuid = prompt("Event UUID?", prop.value || "");
                            process(uuid);
                        },
                    },                    
                    text: {
                        format: "entity",
                        shortcut: "t",
                        className: "text",
                        zeroPointClassName: "zero-text",
                        attributes: {
                            position: {
                                renderer: function (prop) {
                                    return "position [" + (prop.attributes.position || "") + "] <button data-toggle='tooltip' data-original-title='Set' class='btn btn-sm'><span class='fa fa-pencil'></span></button>";
                                },
                                selector: function (prop, process) {
                                    var position = prompt("Position?", prop.attributes.position);
                                    process(position);
                                }
                            }
                        },
                        showConvertToZeroPoint: function (prop) {
                            return !prop.isZeroPoint;
                        },
                        labelRenderer: function (prop) {
                            return prop.isZeroPoint ? "<span class='output-text'>footnote<span>" : "<span class='output-text'>text<span>";
                        },
                        zeroPointLabelSelector: function (prop, process) {
                            var label = prompt("Label", prop.text);
                            process(label);
                        },
                        propertyValueSelector: function (prop, process) {
                            var uuid = prompt("Text UUID?", prop.value || "");
                            process(uuid);
                        }
                    },
		            place: {
                        format: "entity",
                        className: "place",
                        propertyValueSelector: function (prop, process) {
                            var uuid = prompt("Place", prop.value || "");
                            process(uuid);
                        }
                    }, 
                    webLink: {
                        format: "entity",
                        className: "web-link",
                        propertyValueSelector: function (prop, process) {
                            var uuid = prompt("Web Link", prop.value || "");
                            process(uuid);
                        }
                    }, 
                    date: {
                        format: "entity",
                        className: "date",
                        propertyValueSelector: function (prop, process) {
                            var uuid = prompt("Date/Time", prop.value || "");
                            process(uuid);
                        }
                    },                    
                    concept: {
                        format: "entity",
                        className: "concept",
                        propertyValueSelector: function (prop, process) {
                            var uuid = prompt("Concept UUID?", prop.value || "");
                            process(uuid);
                        }
                    },                    
                    }
					});
					this.editor.bind({
						text: cons.editor.text || "",
						properties: cons.editor.properties || []
					});
				}
                Model.prototype.layerClicked = function (layer) {
            var selected = layer.selected();
            this.editor.setLayerVisibility(layer.name, selected);
            return true;
        };
        Model.prototype.isActiveMode = function(mode) {
            var modes = this.currentModes();
            return modes.indexOf(mode) >= 0;
        };
        Model.prototype.spaceClicked = function () {
            this.toggleAnnotation("space");
        };
        Model.prototype.pageClicked = function () {
            this.editor.modeClicked("page");
        };
        Model.prototype.toggleAnnotation = function (type) {
            if (this.isActiveMode(type)) {
                this.editor.deleteAnnotation(type);
                this.currentModes.pop(type);
            } else {
                this.editor.modeClicked(type);
            }           
        };
        Model.prototype.hyphenClicked = function () {
            this.editor.modeClicked("hyphen");
        };
        Model.prototype.changeLineHeightClicked = function(){
            changeCss(".editor", "line-height", this.lineHeight());
        };
        Model.prototype.changeFontSizeClicked = function(){
            changeCss(".editor", "font-size", this.fontSize());
        };
        Model.prototype.changeFontFamilyClicked = function(){
            changeCss(".editor", "font-family", this.fontFamily());
        };
        Model.prototype.changeTextColourClicked = function(){
            changeCss(".editor", "color", this.textColour());
        };
        Model.prototype.changeBackgroundColourClicked = function(){
            changeCss(".editor", "background-color", this.backgroundColour());
        };
        Model.prototype.boldClicked = function () {
            this.toggleAnnotation("bold");
        };
        Model.prototype.italicsClicked = function () {
            this.toggleAnnotation("italics");  
        };
        Model.prototype.strikeClicked = function () {
            this.toggleAnnotation("strike");
        };
        Model.prototype.superscriptClicked = function () {
            this.toggleAnnotation("superscript");
        };
        Model.prototype.subscriptClicked = function () {
            this.toggleAnnotation("subscript");
        };
        Model.prototype.underlineClicked = function () {
            this.toggleAnnotation("underline");
        };       
        Model.prototype.lineClicked = function () {
            this.editor.modeClicked("line");
        };
        Model.prototype.paragraphClicked = function () {
            this.editor.modeClicked("paragraph");
        };
        Model.prototype.personClicked = function () {
            this.editor.modeClicked("person");
        };
        Model.prototype.textClicked = function () {
            this.editor.modeClicked("text");
        };
        Model.prototype.webLinkClicked = function () {
            this.editor.modeClicked("webLink");
        };
        Model.prototype.eventClicked = function () {
            this.editor.modeClicked("event");
        };
        Model.prototype.placeClicked = function () {
            this.editor.modeClicked("place");
        }; 
        Model.prototype.dateClicked = function () {
            this.editor.modeClicked("date");
        };
        Model.prototype.conceptClicked = function () {
            this.editor.modeClicked("concept");
        };
        Model.prototype.unbindClicked = function(){
            var data = this.editor.unbind();
            this.viewer(JSON.stringify(data));
        };
        Model.prototype.loadClicked = function(){
            var _this = this;
            var file = this.file();
            $.get(file, function(json){
                _this.editor.bind(json);
                _this.viewer(null);
            });
        };
        Model.prototype.bindClicked = function () {
            var data = JSON.parse(this.viewer() || '{}');
            this.editor.bind({
                text: data.text,
                properties: data.properties
            });
        }
        return Model;
    })();

        var template = document.getElementById("main-template");
        $.get("ReggF3-H19-316.json", function(json){        
            var model = new Model({
                template: template,
                editor: json
            });
            ko.applyBindings(model, template);
        });
			
        });
    </script>
</body>
</html>
